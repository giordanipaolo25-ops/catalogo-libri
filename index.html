<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogo libri di psicologia</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 980px; margin: auto; padding: 20px; line-height: 1.35; }
    h1 { margin: 0 0 8px 0; font-size: 28px; }
    .subtitle { margin: 0 0 10px 0; color:#222; }
    .email { margin: 0 0 14px 0; font-weight: 800; }
    .email a { color: inherit; text-decoration: none; border-bottom: 1px dotted #888; }
    .email a:hover { border-bottom-style: solid; }
    .smallnote { margin: 0 0 18px 0; color:#444; }

    .row { display:flex; gap:10px; align-items:center; }
    input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 10px; }
    .btn {
      padding: 11px 12px; border-radius: 10px; border: 1px solid #bbb; background:#fff; cursor:pointer; font-weight:700;
      white-space: nowrap;
    }
    .btn:hover { border-color:#111; }

    .countbox {
      margin-top: 10px;
      display: inline-block;
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      background: #fafafa;
      font-weight: 900;
      color:#222;
    }

    .section-title { margin: 16px 0 8px 0; font-size: 14px; font-weight: 900; color: #333; }
    .chips { display:flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    .chip {
      border: 1px solid #bbb; background:#fff; padding: 6px 9px; border-radius: 999px;
      cursor: pointer; font-size: 13px;
    }
    .chip:hover { border-color:#111; }
    .chip.active { border-color:#111; font-weight: 900; }

    .moreRow { display:flex; gap:10px; align-items:center; margin-bottom: 14px; }
    .muted { color:#666; font-size: 13px; }

    .results-head { display:flex; align-items: baseline; justify-content: space-between; gap: 10px; margin-top: 10px; }
    .book { border-bottom: 1px solid #eee; padding: 12px 0; }
    .meta { color:#444; margin-top: 2px; }
    .sold { color:#888; }
    .badge { display:inline-block; margin-top: 6px; font-weight: 900; }

    .buyRow { margin-top: 8px; display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .actionbtn {
      display:inline-block; padding: 8px 10px; border-radius: 10px; border: 1px solid #bbb; background:#fff;
      cursor:pointer; font-weight:800; font-size: 13px; text-decoration:none; color: inherit;
    }
    .actionbtn:hover { border-color:#111; }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-weight: 800;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>

  <h1>Catalogo libri di psicologia</h1>

  <p class="subtitle">
    I libri provengono dalla biblioteca di due psichiatri. Alcuni libri sono sottolineati, ma la maggior parte sono in ottime condizioni.<br>
    Scrivimi per avere informazioni pi√π dettagliate sui volumi e su come comprarli!
  </p>

  <p class="email">
    <a href="mailto:giordani.paolo25@gmail.com">giordani.paolo25@gmail.com</a>
  </p>
  <p class="smallnote">Foto disponibili su richiesta.</p>

  <!-- Ricerca + Reset -->
  <div class="row">
    <input id="search" placeholder="Cerca per autore, titolo o editore‚Ä¶" />
    <button class="btn" id="resetBtn" type="button">Reset</button>
  </div>

  <!-- Box conteggio disponibili -->
  <div id="availBox" class="countbox"></div>

  <!-- RISULTATI SUBITO SOTTO -->
  <div class="results-head">
    <div class="section-title" style="margin:18px 0 8px 0;">Risultati</div>
    <div class="muted" id="status"></div>
  </div>
  <div id="list"></div>

  <!-- POI: Bottoni compressi -->
  <div class="section-title">Editori</div>
  <div class="chips" id="editorChips"></div>
  <div class="moreRow">
    <button class="btn" id="moreEditorsBtn" type="button">Mostra altri</button>
    <div class="muted" id="editorsHint"></div>
  </div>

  <div class="section-title">Autori</div>
  <div class="chips" id="authorChips"></div>
  <div class="moreRow">
    <button class="btn" id="moreAuthorsBtn" type="button">Mostra altri</button>
    <div class="muted" id="authorsHint"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  const CONTACT_EMAIL = "giordani.paolo25@gmail.com";
  const CATALOG_FILE = "catalogo_libri_sito_definitivo.csv"; // se hai un nome diverso, cambialo qui
  const DEFAULT_CHIPS = 12;
  const PREVIEW_N = 15;

  // CSV parser robusto (virgole tra virgolette + doppi apici)
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"') {
        if (inQuotes && next === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }

      if (!inQuotes && c === ',') {
        row.push(field);
        field = '';
        continue;
      }

      if (!inQuotes && (c === '\n' || c === '\r')) {
        if (c === '\r' && next === '\n') i++;
        row.push(field);
        field = '';
        if (row.some(x => String(x).trim() !== '')) rows.push(row);
        row = [];
        continue;
      }

      field += c;
    }

    row.push(field);
    if (row.some(x => String(x).trim() !== '')) rows.push(row);
    return rows;
  }

  function sortIT(arr) {
    return arr.sort((a,b) => a.localeCompare(b, "it", { sensitivity: "base" }));
  }
  function norm(s) { return String(s || "").trim(); }
  function isSold(b) { return norm(b.disponibile).toLowerCase() === "no"; }

  function shuffleCopy(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => t.style.display = "none", 1600);
  }

  function updateAvailBox() {
    const avail = books.filter(b => !isSold(b)).length;
    const total = books.length;
    const el = document.getElementById("availBox");
    el.textContent = `üü¢ ${avail} libri disponibili ¬∑ Totale: ${total}`;
  }

  function mailtoForBook(b) {
    const subject = encodeURIComponent(`Libro: ${b.autore} ‚Äî ${b.titolo}`);
    const body = encodeURIComponent(
`Ciao Paolo,
sono interessato a questo libro:

Autore: ${b.autore}
Titolo: ${b.titolo}
Editore: ${b.editore}
Anno: ${b.anno}${b.prezzo ? "\nPrezzo: " + b.prezzo + " ‚Ç¨" : ""}

Mi puoi dire:
- stato del volume (sottolineature, segni, ecc.)
- modalit√† di acquisto/spedizione

Grazie!`
    );
    return `mailto:${CONTACT_EMAIL}?subject=${subject}&body=${body}`;
  }

  function bookHTML(b) {
    const sold = isSold(b);
    const anno = b.anno ? `(${b.anno})` : "";
    const prezzo = b.prezzo ? `üí∂ ${b.prezzo} ‚Ç¨` : "";
    return `
      <div class="book ${sold ? "sold" : ""}">
        <div><strong>${b.titolo}</strong></div>
        <div class="meta">${b.autore} ‚Äî ${b.editore} ${anno}</div>
        ${prezzo ? `<div class="meta">${prezzo}</div>` : ``}
        <div class="badge">${sold ? "üî¥ Venduto" : "üü¢ Disponibile"}</div>
        <div class="buyRow">
          <a class="actionbtn" href="${mailtoForBook(b)}">Apri email</a>
          <button class="actionbtn" type="button" data-copy="${CONTACT_EMAIL}">Copia email</button>
        </div>
      </div>
    `;
  }

  let books = [];
  let previewBooks = null;

  let activeEditor = "";
  let activeAuthor = "";
  let showAllEditors = false;
  let showAllAuthors = false;

  const editorChips = document.getElementById("editorChips");
  const authorChips = document.getElementById("authorChips");
  const list = document.getElementById("list");
  const status = document.getElementById("status");
  const search = document.getElementById("search");
  const resetBtn = document.getElementById("resetBtn");

  const moreEditorsBtn = document.getElementById("moreEditorsBtn");
  const moreAuthorsBtn = document.getElementById("moreAuthorsBtn");
  const editorsHint = document.getElementById("editorsHint");
  const authorsHint = document.getElementById("authorsHint");

  function clearActiveChips(container) {
    [...container.querySelectorAll(".chip")].forEach(b => b.classList.remove("active"));
  }

  function setStatusText(txt) {
    status.textContent = txt || "";
  }

  function render() {
    const q = norm(search.value).toLowerCase();

    let filtered = books.filter(b => {
      if (activeEditor && !b.editore.toLowerCase().includes(activeEditor.toLowerCase())) return false;
      if (activeAuthor && !b.autore.toLowerCase().includes(activeAuthor.toLowerCase())) return false;

      if (q) {
        const hay = `${b.autore} ${b.titolo} ${b.editore}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    // Ordina: disponibili prima, poi venduti
    filtered = filtered.sort((a,b) => Number(isSold(a)) - Number(isSold(b)));

    // Se nessun filtro e nessuna ricerca: mostra solo anteprima casuale
    const noFilters = !activeEditor && !activeAuthor && !q;
    let toShow = filtered;
    if (noFilters && previewBooks) {
      toShow = previewBooks;
      setStatusText(`Vetrina casuale (${toShow.length}) ‚Äî cerca o scegli autore/editore per vedere tutto`);
    } else {
      const parts = [];
      if (activeEditor) parts.push(`Editore: ${activeEditor}`);
      if (activeAuthor) parts.push(`Autore: ${activeAuthor}`);
      if (q) parts.push(`Ricerca: ‚Äú${search.value}‚Äù`);
      parts.push(`${filtered.length} risultati`);
      setStatusText(parts.join(" ‚Ä¢ "));
    }

    list.innerHTML = "";
    if (toShow.length === 0) {
      list.innerHTML = `<div class="muted">Nessun risultato.</div>`;
      return;
    }

    toShow.forEach(b => list.insertAdjacentHTML("beforeend", bookHTML(b)));
  }

  function buildChips() {
    const editors = sortIT([...new Set(books.map(b => b.editore).filter(Boolean))]);
    const authors = sortIT([...new Set(books.map(b => b.autore).filter(Boolean))]);

    function renderEditors() {
      editorChips.innerHTML = "";
      const shown = showAllEditors ? editors : editors.slice(0, DEFAULT_CHIPS);
      shown.forEach(ed => {
        const btn = document.createElement("button");
        btn.className = "chip";
        btn.textContent = ed;
        btn.type = "button";
        btn.onclick = () => {
          activeEditor = ed;
          activeAuthor = "";
          clearActiveChips(authorChips);
          clearActiveChips(editorChips);
          btn.classList.add("active");
          render();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        editorChips.appendChild(btn);
      });

      if (editors.length <= DEFAULT_CHIPS) {
        moreEditorsBtn.style.display = "none";
        editorsHint.textContent = `${editors.length} editori`;
      } else {
        moreEditorsBtn.style.display = "inline-block";
        moreEditorsBtn.textContent = showAllEditors ? "Mostra meno" : "Mostra altri";
        editorsHint.textContent = showAllEditors
          ? `${editors.length} editori (tutti visibili)`
          : `${DEFAULT_CHIPS} di ${editors.length} editori`;
      }
    }

    function renderAuthors() {
      authorChips.innerHTML = "";
      const shown = showAllAuthors ? authors : authors.slice(0, DEFAULT_CHIPS);
      shown.forEach(au => {
        const btn = document.createElement("button");
        btn.className = "chip";
        btn.textContent = au;
        btn.type = "button";
        btn.onclick = () => {
          activeAuthor = au;
          activeEditor = "";
          clearActiveChips(editorChips);
          clearActiveChips(authorChips);
          btn.classList.add("active");
          render();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        authorChips.appendChild(btn);
      });

      if (authors.length <= DEFAULT_CHIPS) {
        moreAuthorsBtn.style.display = "none";
        authorsHint.textContent = `${authors.length} autori`;
      } else {
        moreAuthorsBtn.style.display = "inline-block";
        moreAuthorsBtn.textContent = showAllAuthors ? "Mostra meno" : "Mostra altri";
        authorsHint.textContent = showAllAuthors
          ? `${authors.length} autori (tutti visibili)`
          : `${DEFAULT_CHIPS} di ${authors.length} autori`;
      }
    }

    moreEditorsBtn.onclick = () => { showAllEditors = !showAllEditors; renderEditors(); };
    moreAuthorsBtn.onclick = () => { showAllAuthors = !showAllAuthors; renderAuthors(); };

    renderEditors();
    renderAuthors();
  }

  function makePreview() {
    const onlyAvailable = books.filter(b => !isSold(b));
    const pool = onlyAvailable.length ? onlyAvailable : books;
    previewBooks = shuffleCopy(pool).slice(0, PREVIEW_N);
  }

  function resetAll() {
    activeEditor = "";
    activeAuthor = "";
    search.value = "";
    clearActiveChips(editorChips);
    clearActiveChips(authorChips);
    makePreview();   // nuova vetrina casuale
    render();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // Copia email (universale)
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-copy]");
    if (!btn) return;
    const value = btn.getAttribute("data-copy") || "";
    try {
      await navigator.clipboard.writeText(value);
      showToast("Email copiata ‚úî");
    } catch {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = value;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      showToast("Email copiata ‚úî");
    }
  });

  // Caricamento catalogo
  fetch(CATALOG_FILE, { cache: "no-store" })
    .then(r => r.text())
    .then(text => {
      const rows = parseCSV(text);
      if (rows.length < 2) throw new Error("CSV vuoto");

      const header = rows[0].map(h => norm(h).toLowerCase());
      const idx = (name) => header.indexOf(name);

      const iAutore = idx("autore");
      const iTitolo = idx("titolo");
      const iEditore = idx("editore");
      const iAnno = idx("anno");
      const iPrezzo = idx("prezzo");
      const iDisp = idx("disponibile");

      books = rows.slice(1).map(r => ({
        autore: norm(r[iAutore]),
        titolo: norm(r[iTitolo]),
        editore: norm(r[iEditore]),
        anno: norm(r[iAnno]),
        prezzo: norm(r[iPrezzo]),
        disponibile: norm(r[iDisp] || "s√¨")
      })).filter(b => b.autore || b.titolo || b.editore);

      updateAvailBox();
      makePreview();
      buildChips();
      render();
    })
    .catch(err => {
      list.innerHTML = `<div class="muted">Errore nel caricamento del catalogo. Controlla che <b>${CATALOG_FILE}</b> sia nella stessa cartella del sito.</div>`;
      setStatusText(String(err));
    });

  search.addEventListener("input", render);
  resetBtn.addEventListener("click", resetAll);
</script>

</body>
</html>
